<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Whales Airdrop</title>

  <!-- Telegram Mini App -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- ✅ Firebase SDK (Compat Version) -->
 <!-- ✅ Firebase SDKs (Compat Version - Works with firebase.initializeApp) -->
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-database-compat.js"></script>
  <style>
    /* ==== GOLD / ORANGE THEME ==== */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(to bottom, #fff8e1, #ffe0b2);
      color: #333;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: linear-gradient(90deg, #ffb300, #ff8f00);
      color: white;
      text-align: center;
      padding: 15px 0;
      font-size: 22px;
      font-weight: bold;
    }

    .container {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }

    .card {
      background: white;
      margin: 10px 0;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
    }

    h2,
    h3 {
      margin: 0 0 10px;
      color: #ff6f00;
    }

    .btn {
      display: inline-block;
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      background: linear-gradient(90deg, #ffb300, #ff6f00);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 15px;
      cursor: pointer;
    }

    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      text-align: center;
    }

    .stat-box {
      background: #fff3e0;
      padding: 10px;
      border-radius: 8px;
    }

    .timer {
      font-weight: bold;
      color: #ff5722;
    }

    nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(90deg, #ffb300, #ff8f00);
      display: flex;
      justify-content: space-around;
      padding: 8px 0;
      border-top: 2px solid #ff9800;
    }

    nav button {
      background: none;
      border: none;
      color: white;
      font-weight: bold;
      cursor: pointer;
      font-size: 14px;
    }

    nav button.active {
      text-decoration: underline;
    }

    .hidden {
      display: none;
    }

    input,
    select {
      width: 100%;
      padding: 8px;
      margin: 5px 0;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    /* Referral link style */
    #refLink {
      word-wrap: break-word;
      font-size: 12px;
      color: #444;
      background: #fffde7;
      padding: 5px;
      border-radius: 5px;
    }
  </style>
  <style>
    .task-icon {
  width: 55px;
  height: 55px;
  border-radius: 12px;
  object-fit: cover;
  background-color: #222;
}
  </style>
  <style>
    .task-card {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: inherit;
  border: 1px solid #ccc;
  border-radius: 12px;
  padding: 12px 15px;
  margin-bottom: 10px;
}

.task-icon {
  width: 55px;
  height: 55px;
  border-radius: 12px;
  object-fit: cover;
  margin-right: 12px;
}

.task-content {
  flex: 1;
}

.task-content h4 {
  margin: 0;
  font-size: 15px;
  font-weight: 600;
}

.task-content p {
  margin: 4px 0;
  font-size: 13px;
  color: inherit;
}

.claim-btn {
  border: 1px solid #999;
  border-radius: 8px;
  padding: 6px 12px;
  background: transparent;
  cursor: pointer;
  font-size: 13px;
  font-weight: 600;
  margin-right: 10px;
  margin-right: 15px;
}

.claim-btn:hover {
  background: #f2f2f2;
}
  </style>
  <style>
    .task-card {
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 12px;
  padding: 15px;
  margin: 12px 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 2px 5px rgba(0,0,0,0.08);
}

.task-content {
  flex: 1;
  margin-right: 15px;
}

.task-content h4 {
  margin: 0;
  font-size: 16px;
  color: #222;
}

.task-content p {
  margin: 4px 0;
  font-size: 13px;
  color: #555;
}

.claim-btn {
  background: #ff9f43;
  color: white;
  border: none;
  border-radius: 8px;
  padding: 10px 16px;
  font-weight: 600;
  cursor: pointer;
  transition: 0.2s;
  margin-right: 15px;
}

.claim-btn:hover {
  background: #ff7b00;
  transform: scale(1.05);
}
  </style>
</head>

<body>
  
  <header>🐋 Whales Airdrop</header>
  <style>
  .hidden {
  display: none;
}
</style>
  <div class="container">
    

 <!-- 🏠 HOME SECTION -->
<section id="home">

  <!-- 🔸 Balance Card -->
  <div class="card">
    <h2>Balance: <span id="balanceAmount">0.00</span> AFN</h2>
    <p>Equivalent: <span id="usdt">0.00</span> USDT</p>
  </div>

  <!-- 🔸 Stats Section -->
  <div class="card stats">
    <div class="stat-box">
      <h3>Today's Ads</h3>
      <p id="todayAds">0 / 5</p>
    </div>

    <div class="stat-box">
      <h3>Referrals</h3>
      <p id="referralsCount">0</p>
    </div>

    <div class="stat-box">
      <h3>Total Income</h3>
      <p id="totalIncome">0 AFN</p>
    </div>

    <div class="stat-box">
      <h3>Withdrawn</h3>
      <p id="withdrawn">0 AFN</p>
    </div>
  </div>

<!-- Referral Link Section -->
<div class="card" style="text-align:left;">

  <!-- Invite Text -->
  <p style="color:#ff9800; font-weight:600; font-size:15px; margin-bottom:6px;">
    💸 Invite friends and earn <b>3 AFN</b> for each referral!
  </p>

  <!-- Visible Referral Link Area -->
  <p id="referrallinkText"
     style="font-size:14px; color:#222; background:#fff; border:1px solid #ccc;
            border-radius:6px; padding:8px; margin:0 0 8px 0; word-wrap:break-word;">
     Referral link will appear here
  </p>

  <!-- Copy Button -->
   <button id="copyReferral" class="btn-copy"
  style="background:orange; color:#fff; font-weight:bold; border:none; border-radius:5px; padding:8px 15px; cursor:pointer;">
  Copy Referral
</button>

</div>
</section>
    
  

  <!-- ✅ TASKS SECTION -->
   <section id="tasks" class="hidden">
  <div class="card">
    <h3>🎬 Daily Ads (Watch & Earn)</h3>
    <div id="adsContainer">
      <!-- Daily ad will appear here -->
    </div>
  </div>

  <div class="card">
    <h3>🎯 Bonus Tasks</h3>
    <div id="adsList">
      <!-- Bonus ads will appear here -->
    </div>
  </div>
</section>

    

    <!-- 🏆 LEADERBOARD SECTION -->
<section id="leaderboard" class="hidden">
  <div class="container">

    <h2 style="color:#ff9800; text-align:center;">🏆 Leaderboard</h2>

    <!-- Grid Layout for Two Cards -->
    <div style="display:flex; gap:15px; justify-content:center; flex-wrap:wrap;">

      <!-- 🟩 Top Referrers -->
      <div class="card" style="flex:1; min-width:260px;">
        <h3>Top Referrers</h3>
        <ul id="topReferrers" style="list-style:none; padding:0; margin:0;">
          <li>Loading...</li>
        </ul>
      </div>

      <!-- 🟦 Top Earners -->
      <div class="card" style="flex:1; min-width:260px;">
        <h3>Top Earners</h3>
        <ul id="topEarners" style="list-style:none; padding:0; margin:0;">
          <li>Loading...</li>
        </ul>
      </div>

    </div>
  </div>
</section>


    <!-- 👤 PROFILE -->
    <section id="profile" class="hidden">
      <h2>Withdraw Funds</h2>
<p style="color: #e67e22; font-weight: 600; margin-bottom: 10px;">
  🔸 Invite 10 friends and you must have at least 50 AFN for Withdrawal.
حداقل باید لس کسان دعوت ولري، او اکونټ کي 50 افغانی ولری ترڅو د پیسو ویستلو برخه فعاله شي

</p>
      

      <select id="method">
  <option value="AWCC">AWCC — MIN: 50 AFN</option>
  <option value="Roshan">Roshan — MIN: 50 AFN</option>
  <option value="Etisalat">Etisalat — MIN: 50 AFN</option>
  <option value="Salaam">Salaam — MIN: 50 AFN</option>
  <option value="Hesab Pay">Hesab Pay — MIN: 150 AFN</option>
</select>

      <input id="account" type="text" placeholder="Enter account / mobile number" />
      <input id="withdrawAmount" type="number" placeholder="Enter amount (AFN)" />
      <button id="withdrawBtn" onclick="withdraw()">Withdraw</button>

      <!-- Withdraw Sections (Requests + History side by side) -->
<div class="withdraw-sections" style="display: flex; gap: 20px; justify-content: space-between; margin-top: 15px;">
  
  <!-- Withdraw Requests -->
  <div style="flex: 1; border: 1px solid #ccc; padding: 10px; border-radius: 8px; background: #fffaf0;">
    <h3 style="color: #e67e22;">Withdraw Requests</h3>
    <div id="withdrawRequestsList">
      <p>No withdrawals found yet.</p>
    </div>
  </div>

  <!-- Withdraw History -->
  <div style="flex: 1; border: 1px solid #ccc; padding: 10px; border-radius: 8px; background: #f9f9f9;">
    <h3 style="color: #27ae60;">Withdraw History</h3>
    <div id="withdrawHistoryList">
      <p>No records yet.</p>
    </div>
  </div>

</div>
    </section>
  </div>

  <nav>
    <button class="active" onclick="showTab('home')">Home</button>
    <button onclick="showTab('tasks')">Tasks</button>
    <button onclick="showTab('leaderboard')">Leaderboard</button>
    <button onclick="showTab('profile')">Profile</button>
  </nav>
  
    <script>
  // 🔹 Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyDmI8qrz_cuKO2pX5ZFXDLKHhjl1c3eNQs",
    authDomain: "scalpers-rewards.firebaseapp.com",
    databaseURL: "https://scalpers-rewards-default-rtdb.firebaseio.com",
    projectId: "scalpers-rewards",
    storageBucket: "scalpers-rewards.appspot.com",
    messagingSenderId: "273507171261",
    appId: "1:273507171261:web:d06a96ba9992115b91f04d",
    measurementId: "G-FX016V8B35"
  };

  // 🔹 Initialize Firebase
  firebase.initializeApp(firebaseConfig);

  // 🔹 Global Variables
  const database = firebase.database();
  window.database = database;
  window.db = database;

  // 🔹 Authentication setup
  const auth = firebase.auth();
  window.auth = auth;

  

  // 🔹 Handle Auth State
  auth.onAuthStateChanged((user) => {
    if (user) {
      currentUser = user;
      console.log("✅ Logged in:", user.uid);
    } else {
      console.log("⚠️ No user found, signing in anonymously...");
      auth.signInAnonymously()
        .then((res) => {
          currentUser = res.user;
          console.log("✅ Anonymous login done:", currentUser.uid);
        })
        .catch((err) => {
          console.error("❌ Anonymous login error:", err);
          loadAds();
        });
    }
  });

  console.log("🔥 Firebase connected successfully!");
</script>
 

<script>
// 🔧 Firebase compat helpers – required for old SDK style
function ref(db, path) {
  return db.ref(path);
}

function onValue(reference, callback) {
  return reference.on("value", callback);
}

function set(ref, data) {
  return ref.set(data);
}

function get(ref) {
  return ref.once("value");
}

function update(ref, data) {
  return ref.update(data);
}

function remove(ref) {
  return ref.remove();
}
</script>

<script>
// ✅ Initialize User (Firebase Version)
async function initUser() {
  try {
    // د Telegram یا local user پیژندنه
    let userId = localStorage.getItem("UID") || null;

    if (!userId) {
      // د مهمان لپاره نوی ID جوړ کړه
      userId = "guest_" + Math.floor(Math.random() * 100000);
      localStorage.setItem("UID", userId);
    }

    const userRef = ref(window.db, `users/${userId}`);
    const snapshot = await get(userRef);

    if (snapshot.exists()) {
      console.log("✅ Existing user loaded:", userId);
      return snapshot.val();
    } else {
      // که نوی کاروونکی وي، جوړ یې کړه
      const newUser = {
        uid: userId,
        username: `guest_${userId}`,
        balance: 0,
        referrals: 0,
        createdAt: Date.now()
      };
      await set(userRef, newUser);
      console.log("🆕 New user created:", newUser);
      return newUser;
    }
  } catch (err) {
    console.error("❌ Error initializing user:", err);
    return null;
  }
}
</script>

<script>
// ✅ Final Stable Version — Show Referral Link Safely
function showReferralLink() {
  const userId = localStorage.getItem("UID");
  const botUsername = "RewardsAirdropBot";

  if (!userId) {
    console.warn("⚠️ User not initialized yet!");
    return;
  }

  const referralLink = `https://t.me/${botUsername}/start?startapp=${userId}`;

  let attempts = 0;
  const maxAttempts = 20;

  const tryInsert = () => {
    const linkEl = document.getElementById("referralLinkText");
    const copyBtn = document.getElementById("copyReferral");

    if (!linkEl) {
  console.warn("Referral element not ready, skipping retry loop ❌");
  return;
}

    // ✅ When element found
    linkEl.textContent = referralLink;
    linkEl.style.color = "#007bff";
    linkEl.style.cursor = "pointer";
    linkEl.onclick = () => window.open(referralLink, "_blank");

    console.log("✅ Referral link displayed:", referralLink);

    if (copyBtn) {
      copyBtn.onclick = () => {
        navigator.clipboard.writeText(referralLink)
          .then(() => alert("✅ Referral link copied!"))
          .catch(() => alert("⚠️ Could not copy referral link!"));
      };
    }
  };

  tryInsert();
}
</script>


<script>


// ✅ 4. Copy referral link (works on all browsers)
function copyReferral(referralLink) {
  try {
    const tempInput = document.createElement("input");
    tempInput.value = referralLink;
    document.body.appendChild(tempInput);
    tempInput.select();
    document.execCommand("copy");
    document.body.removeChild(tempInput);

    console.log("✅ Referral link copied successfully:", referralLink);
    alert("✅ Referral link copied!");
  } catch (error) {
    console.error("❌ Failed to copy referral link:", error);
    alert("⚠️ Could not copy referral link. Please copy manually.");
  }
}

// ✅ 5. Helper function for Firebase ref
function refFunc(db, path) {
  return window.firebase.database().ref(path);
}

// ✅ 6. Run when app starts
window.addEventListener("DOMContentLoaded", async () => {
  await handleReferralFromAllSources();
  showReferralLink();
  listenToReferrals();
});
</script>



<script>
// ✅ Load Withdrawals for Current User
async function loadWithdraws() {
  try {
    const userId = localStorage.getItem("UID");
    if (!userId) {
      console.warn("⚠️ User ID not found in localStorage!");
      return;
    }

    const withdrawRef = ref(window.db, `withdraws/${userId}`);
    const snapshot = await get(withdrawRef);

    const withdrawList = document.getElementById("withdrawList");
    if (!withdrawList) {
      console.warn("⚠️ withdrawList element not found in DOM!");
      return;
    }

    withdrawList.innerHTML = ""; // clear old data

    if (snapshot.exists()) {
      const data = snapshot.val();
      Object.keys(data).forEach(key => {
        const item = data[key];
        const li = document.createElement("li");
        li.textContent = `💸 ${item.amount} AFN - ${new Date(item.date).toLocaleString()} (${item.status})`;
        withdrawList.appendChild(li);
      });
      console.log("✅ Withdraws loaded!");
    } else {
      withdrawList.innerHTML = "<li>No withdrawals found.</li>";
      console.log("⚠️ No withdrawals found for user:", userId);
    }
  } catch (error) {
    console.error("❌ Error loading withdraws:", error);
  }
}
</script>


<script>
async function loadLeaderboard() {
  try {
    const usersRef = ref(window.db, "users");
    const snapshot = await get(usersRef);
    if (!snapshot.exists()) {
      console.warn("⚠ No leaderboard data available");
      return;
    }

    const users = Object.values(snapshot.val());

    // 🟩 Sort by referrals
    const topReferrers = [...users]
      .sort((a, b) => (b.referrals || 0) - (a.referrals || 0))
      .slice(0, 10);

    // 🟦 Sort by earnings
    const topEarners = [...users]
      .sort((a, b) => (b.balance || 0) - (a.balance || 0))
      .slice(0, 10);

    const refList = document.getElementById("topReferrers");
    const earnList = document.getElementById("topEarners");

    // clear and rebuild lists
    refList.innerHTML = "";
    earnList.innerHTML = "";

    topReferrers.forEach((user, i) => {
      const li = document.createElement("li");
      li.textContent = `#${i + 1} ${user.username || "guest"} — ${user.referrals || 0} refs`;
      refList.appendChild(li);
    });

    topEarners.forEach((user, i) => {
      const li = document.createElement("li");
      li.textContent = `#${i + 1} ${user.username || "guest"} — ${user.balance || 0} AFN`;
      earnList.appendChild(li);
    });

    console.log("🏆 Leaderboard updated!");
  } catch (err) {
    console.error("❌ Error loading leaderboard:", err);
  }
}
</script>




<script>
  // ✅ Load Ads with 15-hour cooldown & split sections
async function loadAds() {
  try {
    const userId = localStorage.getItem("UID");
    if (!userId) {
      console.warn("⚠️ User not initialized yet!");
      return;
    }

    const adsRef = ref(window.db, "ads");
    const adsSnapshot = await get(adsRef);
    const adsContainer = document.getElementById("adsContainer");
    const bonusContainer = document.getElementById("adsList");

    if (!adsSnapshot.exists()) {
      adsContainer.innerHTML = "<p>No ads available</p>";
      bonusContainer.innerHTML = "";
      return;
    }

    const ads = Object.entries(adsSnapshot.val());
    adsContainer.innerHTML = "";
    bonusContainer.innerHTML = "";

    const cooldownRef = ref(window.db, `users/${userId}/watchedAds`);
    const cooldownSnap = await get(cooldownRef);
    const watchedAds = cooldownSnap.exists() ? cooldownSnap.val() : {};
    const now = Date.now();
    const cooldownMs = 15 * 60 * 60 * 1000; // 15 hours

    ads.forEach(([adKey, ad], index) => {
      const adBox = document.createElement("div");
      adBox.className = "ad-card";
      adBox.style.display = "flex";
      adBox.style.justifyContent = "space-between";
      adBox.style.alignItems = "center";
      adBox.style.border = "1px solid #ddd";
      adBox.style.padding = "10px";
      adBox.style.margin = "5px 0";
      adBox.style.borderRadius = "8px";
      adBox.style.background = "#fff";

      const leftSide = document.createElement("div");
      leftSide.innerHTML = `
        <h4>${ad.title}</h4>
        <p style="margin:0; color:#666;">${ad.description || ""}</p>
      `;

      const rightSide = document.createElement("div");
      const button = document.createElement("button");
      button.textContent = "Claim Bonus";
      button.style.background = "orange";
      button.style.color = "#fff";
      button.style.border = "none";
      button.style.padding = "6px 10px";
      button.style.borderRadius = "6px";
      button.style.cursor = "pointer";
      button.style.fontWeight = "bold";

      const lastWatched = watchedAds[adKey];
      const remaining = lastWatched ? cooldownMs - (now - lastWatched) : 0;

      if (remaining > 0) {
        const hours = Math.floor(remaining / 3600000);
        const mins = Math.floor((remaining % 3600000) / 60000);
        const secs = Math.floor((remaining % 60000) / 1000);
        button.textContent = `${hours}:${mins}:${secs}`;
        button.disabled = true;
        button.style.background = "#ccc";
      } else {
        button.onclick = (e) => watchAd(adKey, e);
      }

      rightSide.appendChild(button);
      adBox.appendChild(leftSide);
      adBox.appendChild(rightSide);

      // 🟢 لومړی اعلان دې Daily برخه ته ځي، نور Bonus ته
      if (index === 0) {
        adsContainer.appendChild(adBox);
      } else {
        bonusContainer.appendChild(adBox);
      }
    });

    console.log("✅ Ads loaded successfully!");
  } catch (err) {
    console.error("❌ Error loading ads:", err);
  }
}
</script>


<script>
async function loadUserData() {
  try {
    const userId = localStorage.getItem("UID");
    if (!userId) {
      console.warn("⚠️ No userId found in localStorage!");
      return;
    }

    // Firebase references
    const balanceRef = ref(window.db, `users/${userId}/balance`);
    const referralsRef = ref(window.db, `users/${userId}/referrals`);
    const userRef = ref(window.db, `users/${userId}`);

    // 🟢 Fetch full user data once
    const userSnap = await get(userRef);
    const user = userSnap.exists() ? userSnap.val() : { balance: 0, referrals: 0 };

    

    // ✅ Referral listener
    onValue(referralsRef, (snapshot) => {
      const refs = snapshot.exists() ? snapshot.val() : 0;
      const refEl = document.getElementById("referralsCount");
      if (refEl) refEl.textContent = refs;
      console.log(`👥 Realtime referrals updated: ${refs}`);
    });

  

    console.log("✅ Realtime user data loaded!");

  } catch (error) {
    console.error("❌ Error loading user data:", error);
  }
}
</script>




<script>
// ✅ Update user interface dynamically
function updateUserUI(userData) {
  try {
    // 🔹 HTML عناصر رااخلو
    const balanceEl = document.getElementById("balanceAmount");
    const usdtEl = document.getElementById("usdt");
    const refCountEl = document.getElementById("referralsCount");
    const userIdEl = document.getElementById("userId");

    // 🔹 د کاروونکي معلومات لوډ کوو
    const balance = userData?.balance ?? 0;
    const referrals = userData?.referrals ?? 0;
    const userId = localStorage.getItem("UID");

    // 🔹 د بیلانس او نورو برخو تازه کول
    if (balanceEl) balanceEl.textContent = balance.toFixed(2);
    if (usdtEl) usdtEl.textContent = (balance / 70).toFixed(2); // 1 USDT = 70 AFN
    if (refCountEl) refCountEl.textContent = referrals;
    if (userIdEl) userIdEl.textContent = userId;

    console.log(`✅ User UI updated for ${userId}`);
  } catch (err) {
    console.error("❌ Error updating user UI:", err);
  }
}
</script>



<script>
// ✅ Tab Switcher (controls Home, Tasks, Leaderboard, Profile)
function showTab(tabId) {
  try {
    // ټولې برخې پټې کړو
    document.querySelectorAll("section").forEach(sec => {
      sec.classList.add("hidden");
    });

    // یوازې ټاکل شوی ټب ښکاره کړو
    const activeTab = document.getElementById(tabId);
    if (activeTab) {
      activeTab.classList.remove("hidden");
      console.log(`📱 Switched to tab: ${tabId}`);

      // 🔹 Optional Refresh Actions
      if (tabId === "home") {
        loadUserData(); // update balance live
      } else if (tabId === "tasks") {
        loadAds(); // reload ads when entering Tasks tab
      } else if (tabId === "leaderboard") {
        loadLeaderboard();
      } else if (tabId === "withdraw") {
        // ⚠️ دا نه اضافه کوم، ته مخکې withdraw script لرې
        // loadWithdraws(); // uncomment only if needed
      }
    } else {
      console.warn(`⚠️ Tab not found: ${tabId}`);
    }
  } catch (err) {
    console.error("❌ Error switching tab:", err);
  }
}
</script>




<script>
// ✅ Withdraw System (clean version)
async function withdraw() {
  try {
    const userId = localStorage.getItem("UID");
    if (!userId) {
      alert("⚠️ User not initialized!");
      return;
    }

    const userRef = ref(window.db, `users/${userId}`);
    const userSnap = await get(userRef);

    if (!userSnap.exists()) {
      alert("⚠️ User not found!");
      return;
    }

    const userData = userSnap.val();
    const balance = Number(userData.balance || 0);

    const method = document.getElementById("method").value;
    const account = document.getElementById("account").value.trim();
    const amount = Number(document.getElementById("withdrawAmount").value);

    if (!method || !account || !amount) {
      alert("⚠️ Please fill in all fields!");
      return;
    }

    if (balance < 50) {
      alert("⚠️ You must have at least 50 AFN to withdraw.");
      return;
    }

    if (amount > balance) {
      alert("⚠️ You don't have enough balance!");
      return;
    }

    const withdrawRef = ref(window.db, `withdrawals/${userId}/${Date.now()}`);
    await set(withdrawRef, {
      method,
      account,
      amount,
      status: "pending",
      createdAt: new Date().toISOString(),
    });

    await set(ref(window.db, `users/${userId}/balance`), balance - amount);

    // Deduct balance
await set(ref(window.db, `users/${userId}/balance`), balance - amount);

// ✅ د withdraw وروسته balance تازه کړه
listenToBalance();

// ✅ بټن disable کړه ترڅو د UI همغږي شي
const withdrawBtn = document.getElementById("withdrawBtn");
if (withdrawBtn) {
  withdrawBtn.disabled = true;
  withdrawBtn.style.opacity = "0.6";
  withdrawBtn.style.cursor = "not-allowed";
}

alert("✅ Withdraw request submitted successfully!");
document.getElementById("withdrawAmount").value = "";
document.getElementById("account").value = "";

    alert("✅ Withdraw request submitted successfully!");
    document.getElementById("withdrawAmount").value = "";
    document.getElementById("account").value = "";
  } catch (err) {
    console.error("❌ Withdraw error:", err);
    alert("⚠️ Something went wrong during withdrawal!");
  }
}
</script>

<script>
// ✅ Generate referral link for user
function generateReferralLink() {
  try {
    const userId = localStorage.getItem("UID");
    if (!userId) {
      alert("⚠️ User not found!");
      return;
    }

    const referralLink = `https://t.me/${botUsername}/start?startapp=${userId}`;
    const linkEl = document.getElementById("referralLink");
    const copyBtn = document.getElementById("copyReferralBtn");

    if (linkEl) linkEl.textContent = referralLink;

    // copy button event
    if (copyBtn) {
      copyBtn.onclick = () => {
        navigator.clipboard.writeText(referralLink)
          .then(() => alert("✅ Referral link copied!"))
          .catch(() => alert("⚠️ Failed to copy link."));
      };
    }

    console.log("✅ Referral link generated:", referralLink);
  } catch (err) {
    console.error("❌ Error generating referral link:", err);
  }
}
</script>


<script>
// ✅ Smart User Initializer
async function initSmartUser() {
  try {
    console.log("Initializing Smart User...");

    let userId = localStorage.getItem("UID");

    // if no user exists → make new guest
    if (!userId) {
      userId = "guest_" + Math.floor(Math.random() * 100000);
      localStorage.setItem("UID", userId);

      const userRef = ref(window.db, `users/${userId}`);
      await set(userRef, {
        uid: userId,
        username: userId,
        balance: 0,
        referrals: 0,
        createdAt: Date.now()
      });

      console.log("🆕 New user created:", userId);
    } else {
      console.log("✅ Existing user loaded:", userId);
    }

    // mark SmartUser ready
    console.log("Smart user initialized!");

    // optional: generate referral link immediately
    generateReferralLink();
    loadUserData();
    loadAds();

  } catch (err) {
    console.error("❌ Error initializing Smart User:", err);
  }
}
</script>




<script>
async function initApp() {
  try {
    console.log("🚀 Starting Whales Rewards App...");

    // ✅ Step 1: Extract referral from link
    const urlParams = new URLSearchParams(window.location.search);
    const referralId = urlParams.get("ref");

    // ✅ Step 2: Always reset localStorage when referralId exists
    if (referralId) {
      const savedRef = localStorage.getItem("referredBy");
      const currentUID = localStorage.getItem("UID");

      // ❗ Important: if the referral is new, clear old account
      if (referralId !== savedRef && referralId !== currentUID) {
        console.log("🧹 New referral detected → clearing local data");
        localStorage.clear();
        localStorage.setItem("referredBy", referralId);
      }
    }

    // ✅ Step 3: Create unique UID if not found
    let userId = localStorage.getItem("UID");
    if (!userId) {
      userId = "user_" + Math.random().toString(36).substring(2, 10);
      localStorage.setItem("UID", userId);
      console.log("🆕 New user created:", userId);
    }

    // ✅ Step 4: Initialize Firebase and user
    if (!window.db) {
      alert("⚠️ Database not connected!");
      return;
    }

    const userRef = ref(window.db, "users/" + userId);
    const snapshot = await get(userRef);
    if (!snapshot.exists()) {
      await set(userRef, {
        uid: userId,
        username: "guest_" + userId.slice(-4),
        balance: 0,
        referrals: 0,
        referredBy: localStorage.getItem("referredBy") || null,
        createdAt: Date.now(),
      });
    }

    // ✅ Step 5: Load everything
    await loadUserData();
    updateUserUI();
    showReferralLink();
    console.log("✅ App Ready!");

  } catch (err) {
    console.error("❌ initApp error:", err);
  }
}
</script>



<script>
// ✅ Handle referral from Telegram URL
async function handleReferralFromAllSources() {
  let referralId = null;

  try {
    // 1️⃣ Check Telegram WebApp param (for Telegram App users)
    if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe) {
      const tgData = window.Telegram.WebApp.initDataUnsafe;
      if (tgData.start_param) {
        referralId = tgData.start_param.replace("ref-", "");
        console.log("📲 Referral from Telegram App:", referralId);
      }
    }

    // 2️⃣ Check ?ref= param (for browser users)
    if (!referralId) {
      const urlParams = new URLSearchParams(window.location.search);
      referralId = urlParams.get("ref");
      if (referralId) console.log("🌍 Referral from URL:", referralId);
    }

    // 3️⃣ If found, save in localStorage or Firebase
    if (referralId) {
      localStorage.setItem("referredBy", referralId);
      console.log("✅ Referral saved:", referralId);
    } else {
      console.warn("⚠️ No referral detected (neither Telegram nor URL)");
    }

  } catch (err) {
    console.error("❌ Referral detection error:", err);
  }
}

window.addEventListener("load", handleReferralFromAllSources);
</script>


<script>
// ✅ Copy referral link & live balance updater (merged)
function copyReferralAndTrackBalance() {
  const userId = localStorage.getItem("UID");
  const botUsername = "RewardsAirdropBot"; // 👈 ستا د بوټ username
  const referralLink = `https://t.me/${botUsername}/start?startapp=${userId}`;

  // --- copy referral link ---
  const copyBtn = document.getElementById("copyReferralBtn");
  if (copyBtn) {
    copyBtn.onclick = () => {
      navigator.clipboard.writeText(referralLink)
        .then(() => alert("✅ Referral link copied!"))
        .catch(() => alert("⚠️ Could not copy referral link."));
    };
  }

  const linkEl = document.getElementById("referralLink");
  if (linkEl) {
    linkEl.textContent = referralLink;
    linkEl.href = referralLink;
  }

console.log("✅ Referral active for:", userId);
}
</script>

<script>
// 🟩 Referral Reward System
async function handleReferralReward(newUserId, referrerId) {
  try {
    console.log(`🎯 handleReferralReward triggered for ${referrerId} ← ${newUserId}`);

    const referrerBalanceRef = ref(window.db, `users/${referrerId}/balance`);
    const refListRef = ref(window.db, `users/${referrerId}/referrals/${newUserId}`);

    // ✅ Check if already rewarded
    const alreadyRef = await get(refListRef);
    if (alreadyRef.exists()) {
      console.log("⚠️ Referral already counted, skipping...");
      return;
    }

    // ✅ Add referral record
    await set(refListRef, true);

    // ✅ Get current balance
    const balanceSnap = await get(referrerBalanceRef);
    const currentBalance = balanceSnap.exists() ? Number(balanceSnap.val()) : 0;

    // ✅ Add 3 AFN reward
    const reward = 3;
    const newBalance = currentBalance + reward;
    await set(referrerBalanceRef, newBalance);

    // ✅ Update UI instantly if referrer is online
    if (typeof updateBalanceUI === "function") {
      updateBalanceUI(newBalance);
    }

    console.log(`✅ Referral reward added: ${reward} AFN to ${referrerId}`);
  } catch (err) {
    console.error("❌ Error in handleReferralReward:", err);
  }
}
</script>

<script>
// ---- Sticky realtime balance listener (v8/v9-compatible) ----
let __balanceRef = null;
let __balanceCb  = null;

function updateBalanceUI(balance) {
  const balanceEl = document.getElementById("balanceAmount");
  const usdtEl    = document.getElementById("usdt");
  if (balanceEl) balanceEl.textContent = Number(balance).toFixed(2);
  if (usdtEl)    usdtEl.textContent    = (Number(balance) / 70).toFixed(2);
  // د Withdraw بټن هم هر ځل سنک کړه:
  updateWithdrawButton(Number(balance));
}

// دایمي لیسنر – څو ځل مه جوړوه
function listenToBalanceSticky() {
  const userId = localStorage.getItem("UID");
  if (!userId) return;

  // که مخکې لیسنر و، هماغه پرې (v8 style)
  if (__balanceRef && __balanceCb && __balanceRef.off) {
    __balanceRef.off("value", __balanceCb);
  }

  __balanceRef = window.db.ref(`users/${userId}/balance`);
  __balanceCb  = (snap) => {
    const balance = snap.exists() ? (snap.val() || 0) : 0;
    console.log("💰 Realtime balance:", balance);
    updateBalanceUI(balance);
  };
  __balanceRef.on("value", __balanceCb);
}
</script>


<script>
// 🔹 دا فنکشن سمدستي UI تازه کوي کله چې بیلانس بدلېږي
function updateBalanceUI(newBalance) {
  const balanceEl = document.getElementById("balanceAmount");
  const usdtEl = document.getElementById("usdt");
  const withdrawBtn = document.getElementById("withdrawBtn");

  // بیلانس عدد نوي کړه
  if (balanceEl) balanceEl.textContent = newBalance.toFixed(2);
  if (usdtEl) usdtEl.textContent = (newBalance / 70).toFixed(2);

  // Withdraw بټن فعاله یا غیرفعاله کړه
  if (withdrawBtn) {
    if (newBalance < 50) {
      withdrawBtn.disabled = true;
      withdrawBtn.style.opacity = "0.6";
      withdrawBtn.style.cursor = "not-allowed";
    } else {
      withdrawBtn.disabled = false;
      withdrawBtn.style.opacity = "1";
      withdrawBtn.style.cursor = "pointer";
    }
  }

  console.log("✅ UI updated instantly:", newBalance, "AFN");
}
</script>


<script>
async function watchAd(adKey, event) {
  const btn = event.target;

  try {
    const userId = localStorage.getItem("UID");
    if (!userId) {
      alert("⚠️ User not initialized!");
      return;
    }

    // 📺 د اعلان ډیټا
    const adRef = ref(window.db, `ads/${adKey}`);
    const adSnap = await get(adRef);
    if (!adSnap.exists()) {
      alert("⚠️ Ad not found!");
      return;
    }

    const ad = adSnap.val();
    const reward = Number(ad.reward || 0);
    const adUrl = ad.url;

    // 🚀 اعلان خلاص کړه
    btn.disabled = true;
    btn.textContent = "Opening Ad...";
    const win = window.open(adUrl, "_blank");

    // 🕒 انتظار تر څو اعلان وتړل شي
    const adCheck = setInterval(async () => {
      if (win.closed) {
        clearInterval(adCheck);

        // 💰 Reward زیات کړه کله چې اعلان وتړل شو
        const balanceRef = ref(window.db, `users/${userId}/balance`);
        const balanceSnap = await get(balanceRef);
        const currentBalance = balanceSnap.exists() ? Number(balanceSnap.val()) : 0;
        const newBalance = currentBalance + reward;

        await set(balanceRef, newBalance);
        updateBalanceUI(newBalance);

        // 🔒 اعلان قلف کړه
        const cooldownRef = ref(window.db, `users/${userId}/watchedAds/${adKey}`);
        await set(cooldownRef, Date.now());

        // ✅ UI تازه کړه
        btn.textContent = `✅ Earned ${reward} AFN`;
        btn.style.background = "#4CAF50";
        btn.style.color = "#fff";
        btn.disabled = true;

        console.log("✅ Ad closed, reward added:", reward);
      }
    }, 500);
  } catch (err) {
    console.error("❌ Error in watchAd:", err);
    alert("⚠️ Something went wrong!");
    btn.disabled = false;
  }
}
</script>
<!-- ✅ دا function باید مخکې وي -->
<script>
function updateWithdrawButton(balance) {
  const withdrawBtn = document.getElementById("withdrawBtn");
  if (!withdrawBtn) return;

  if (balance < 50) {
    withdrawBtn.disabled = true;
    withdrawBtn.style.opacity = "0.6";
    withdrawBtn.style.cursor = "not-allowed";
  } else {
    withdrawBtn.disabled = false;
    withdrawBtn.style.opacity = "1";
    withdrawBtn.style.cursor = "pointer";
  }
}
</script>

<script>
// 🟩 Referral Reward System
async function handleReferralReward(newUserId, referrerId) {
  try {
    console.log(`🎯 handleReferralReward triggered for ${referrerId} ← ${newUserId}`);

    const referrerBalanceRef = ref(window.db, `users/${referrerId}/balance`);
    const refListRef = ref(window.db, `users/${referrerId}/referrals/${newUserId}`);

    // ✅ Check if already rewarded
    const alreadyRef = await get(refListRef);
    if (alreadyRef.exists()) {
      console.log("⚠️ Referral already counted, skipping...");
      return;
    }

    // ✅ Add referral record
    await set(refListRef, true);

    // ✅ Get current balance
    const balanceSnap = await get(referrerBalanceRef);
    const currentBalance = balanceSnap.exists() ? Number(balanceSnap.val()) : 0;

    // ✅ Add 3 AFN reward
    const reward = 3;
    const newBalance = currentBalance + reward;
    await set(referrerBalanceRef, newBalance);

    // ✅ Update UI instantly if referrer is online
    if (typeof updateBalanceUI === "function") {
      updateBalanceUI(newBalance);
    }

    console.log(`✅ Referral reward added: ${reward} AFN to ${referrerId}`);
  } catch (err) {
    console.error("❌ Error in handleReferralReward:", err);
  }
}

// 🟨 New user creation hook — detect referrer and give reward
async function checkReferralOnSignup() {
  try {
    const userId = localStorage.getItem("UID");
    if (!userId) return;

    // Check if URL contains ?startapp=guest_...
    const params = new URLSearchParams(window.location.search);
    const referrerId = params.get("startapp");

    if (referrerId && referrerId !== userId) {
      console.log(`🔗 New user referred by ${referrerId}`);
      const userRef = ref(window.db, `users/${userId}/referrer`);
      await set(userRef, referrerId);

      // Reward the inviter
      await handleReferralReward(userId, referrerId);
    } else {
      console.log("⚠️ No referrer detected");
    }
  } catch (err) {
    console.error("❌ Error in checkReferralOnSignup:", err);
  }
}

// 🚀 Run this when app starts
document.addEventListener("DOMContentLoaded", () => {
  checkReferralOnSignup();
});
</script>

<script>
  // 🔹 د referral + balance څارونکی function
function initReferralSystem() {
  const referralBox = document.getElementById("referrallinkText");

  if (!referralBox) {
    console.warn("⚠️ Waiting for referral element...");
    setTimeout(initReferralSystem, 300);
    return;
  }

  console.log("✅ Referral element found!");
  const userId = localStorage.getItem("UID") || "guest_000";
  const referralLink = `https://t.me/RewardsAirdropBot/start?startapp=${userId}`;
  referralBox.textContent = referralLink;
}

// ✅ دا برخه باید د function وروسته وي او بند هم وي
document.addEventListener("DOMContentLoaded", () => {
  initReferralSystem();
});
</script> 

<script>
  // 🔹 Withdraw Button Control by Balance
  function updateWithdrawButton(balance) {
    const withdrawBtn = document.getElementById("withdrawBtn");
    if (!withdrawBtn) return;

    if (balance < 50) {
      withdrawBtn.disabled = true;
      withdrawBtn.style.opacity = "0.6";
      withdrawBtn.style.cursor = "not-allowed"
    } else {
      withdrawBtn.disabled = false;
      withdrawBtn.style.opacity = "1";
      withdrawBtn.style.cursor = "pointer";
    }
  }
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const el = document.getElementById("referrallinkText");
  if (el) {
    console.log("✅ Referral element found in HTML!", el);
  } else {
    console.error("❌ Referral element still missing!");
  }
});
</script>
<script>
  // ✅ Copy Referral Button System
  const copyBtn = document.getElementById("copyReferral");
  const linkEl = document.getElementById("referrallinkText");

  if (copyBtn && linkEl) {
    copyBtn.onclick = async () => {
      try {
        await navigator.clipboard.writeText(linkEl.textContent.trim());
        alert("✅ Referral link copied successfully!");
      } catch (err) {
        alert("⚠️ Failed to copy referral link!");
        console.error(err);
      }
    };
  } else {
    console.warn("⚠️ Copy button or referral link not found in DOM.");
  }
</script>

<script>
function listenToReferrals() {
  const userId = localStorage.getItem("UID");
  if (!userId) return;

  const referralsRef = ref(window.db, `users/${userId}/referrals`);
  onValue(referralsRef, (snapshot) => {
    const referrals = snapshot.exists() ? snapshot.val() : 0;
    console.log("👥 Realtime referrals updated:", referrals);

    const referralEl = document.getElementById("referrals");
    if (referralEl) referralEl.textContent = referrals;
  });
}
</script>

<script>
  function listenToWithdrawals() {
  const userId = localStorage.getItem("UID");
  if (!userId) return;

  const requestsDiv = document.getElementById("withdrawRequestsList");
  const historyDiv = document.getElementById("withdrawHistoryList");

  const withdrawsRef = ref(window.db, `withdrawals/${userId}`);
  onValue(withdrawsRef, (snapshot) => {
    requestsDiv.innerHTML = "";
    historyDiv.innerHTML = "";

    if (!snapshot.exists()) {
      requestsDiv.innerHTML = "<p>No withdrawals found yet.</p>";
      historyDiv.innerHTML = "<p>No records yet.</p>";
      return;
    }

    const data = snapshot.val();
    const entries = Object.values(data).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

    entries.forEach((w) => {
      const item = document.createElement("div");
      item.style.padding = "6px 0";
      item.style.borderBottom = "1px solid #eee";
      item.innerHTML = `
        <strong>${w.method}</strong> — ${w.amount} AFN  
        <br>
        <small>${w.account}</small>
        <br>
        <span style="color:${w.status === 'approved' ? 'green' : w.status === 'pending' ? 'orange' : 'red'}">
          ${w.status.toUpperCase()}
        </span>
        <hr>
      `;

      if (w.status === "approved") historyDiv.appendChild(item);
      else requestsDiv.appendChild(item);
    });
  });
}
</script>


<script>
initApp().then(() => {
  handleReferralFromAllSources(); // 🟢 دا باید دلته راوغوښتل شي
  updateUserUI();
  showTab("home");
  listenToReferrals();
  listenToBalanceSticky();
  listenToWithdrawals();
});
</script>
</body>
</html>